# LM Gateway Caddy Configuration - Local Development
# This configuration provides HTTPS termination, reverse proxy, and static file serving for localhost

# Global configuration
{
    # Disable automatic HTTPS for localhost
    auto_https off
    # Email for Let's Encrypt certificates (only needed if you use real domains later)
    email bildthomas24@gmail.com
    # Enable HTTP/3
    servers {
        protocols h1 h2 h3
    }
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}

# Main LM Gateway - localhost (HTTP only for development)
localhost:80 {
    # Security headers
    header {
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'none';"
        
        # Remove server information
        -Server
        
        # CORS headers for API
        Access-Control-Allow-Origin "http://localhost"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
    
    # Rate limiting
    rate_limit {
        zone static {
            key {remote_host}
            events 100
            window 1m
        }
    }
    
    # API routes - proxy to backend
    handle /api/* {
        reverse_proxy localhost:5058 {
            # Health check
            health_uri /api/health
            health_interval 30s
            health_timeout 5s
            
            # Headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
        
        # CORS preflight
        @options {
            method OPTIONS
        }
        respond @options 200
    }
    
    # WebSocket support for real-time features
    handle /ws/* {
        reverse_proxy localhost:5058 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Static files from frontend build
    handle /assets/* {
        root * ./dist
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
    }
    
    # Serve frontend SPA
    handle {
        root * ./dist
        try_files {path} /index.html
        file_server
        
        # Cache static assets
        header Cache-Control "public, max-age=3600"
    }
}

# HTTPS version for testing (optional)
localhost:443 {
    # Use self-signed certificate for localhost
    tls internal
    
    # Same configuration as HTTP version
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'none';"
        -Server
        Access-Control-Allow-Origin "https://localhost"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
    
    # API routes
    handle /api/* {
        reverse_proxy localhost:5058
    }
    
    # WebSocket support
    handle /ws/* {
        reverse_proxy localhost:5058
    }
    
    # Static files
    handle /assets/* {
        root * ./dist
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
    }
    
    # Serve frontend
    handle {
        root * ./dist
        try_files {path} /index.html
        file_server
    }
}

# API-only endpoint (optional)
api.localhost:80 {
    # API-specific headers
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Max-Age "86400"
    }
    
    # Rate limiting for API
    rate_limit {
        zone api {
            key {remote_host}
            events 1000
            window 1m
        }
    }
    
    # Only API routes
    handle /api/* {
        reverse_proxy localhost:5058
    }
    
    # Block everything else
    handle {
        respond "API endpoint not found" 404
    }
}

# Health check endpoint
health.localhost:80 {
    handle {
        reverse_proxy localhost:5058/api/health
    }
}
